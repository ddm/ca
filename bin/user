#!/usr/bin/env sh

set -e

: ${1?User?}
: ${2?Root?}

USER=$1
ROOT=$2
PASSWORD=${3:-$(dd if=/dev/urandom bs=8 count=1 2>/dev/null | base64 | sed 's/=//g')}

openssl genrsa -passout pass:${PASSWORD} -aes256 -out /tmp/${USER}.key 4096 && chmod 600 /tmp/${USER}.key
openssl req -passin pass:${PASSWORD} -subj "/O=${ROOT}/CN=${USER}" -new -sha256 -key /tmp/${USER}.key -out /tmp/${USER}.csr
openssl x509 -passin pass:${PASSWORD} -req -days 365 -in /tmp/${USER}.csr -CA /tmp/${ROOT}.crt -CAkey /tmp/${ROOT}.key -CAcreateserial -CAserial /tmp/${ROOT}.seq -out /tmp/${USER}.crt
openssl pkcs12 -passin pass:${PASSWORD} -passout pass:${PASSWORD} -export -clcerts -in /tmp/${USER}.crt -inkey /tmp/${USER}.key -out /tmp/${USER}.p12
openssl x509 -text -noout -in /tmp/${USER}.crt

echo "┌─────────────┐"
echo "│ ${PASSWORD} │"
echo "└─────────────┘"
